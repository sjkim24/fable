<%= render partial: "show", locals: { story: @story } %>

<div class="">
  <div>
    <div><%= @story_likes.count %> likes for this story</div>
    <% if @story_liked %>
      <% url = story_like_url %>
      <% req_method = "delete" %>
      <% story_like_id = @like_id %>
    <% else %>
      <% url = story_story_likes_url(@story.id) %>
      <% req_method = "post" %>
      <% story_like_id = nil %>
    <% end %>
    
    <% if @story_bookmarked %>
      <% bookmark = Bookmark.where(user_id: current_user.id, story_id: @story.id)[0] %>
      <% bookmark_url, bookmark_req  = bookmark_url(bookmark), "delete" %>
    <% else %>
      <% bookmark_url, bookmark_req = story_bookmarks_url(@story.id), "post" %>
    <% end %>

    <%= render partial: "likes/story_like_form", locals: { url: url, story_liked: @story_liked, like_id: story_like_id, story_or_comment: @story, method: req_method } %>
    <%= render partial: "bookmarks/form", locals: { bookmark_url: bookmark_url, method: bookmark_req } %>
  </div>
  <div class="">Comment on this story</div>
  <%= render partial: "comments/form", locals: { url: story_comments_url(@story.id), parent_comment_id: nil, method: "post" } %>
</div>

<div class="">Comments for story id <%= @story.id %></div>
<ul>
  <% @comments.each do |comment| %>
    <li>
      <div class=""><%= comment.content %></div>
      <div class="">by <a href="<%= user_url(comment.user.id) %>"><%= comment.user.username %></a></div>
      <%= render partial: "comments/destroy", locals: { id: comment.id } %>
      <div class="">
        <% comment_liked = comment.liked?(comment.id, current_user.id) %>
        <% if comment_liked %>
          <% url = comment_like_url %>
          <% req_method = "delete" %>
          <% comment_like_id = comment.like_id(comment.id, current_user.id) %>
        <% else %>
          <% url = comment_comment_likes_url(comment.id) %>
          <% req_method = "post" %>
          <% comment_like_id = nil %>
        <% end %>
        
        <%= render partial: "comments/form", locals: { url: story_comments_url(@story.id), parent_comment_id: comment.id, method: "post" } %>
        <%= render partial: "likes/comment_like_form", locals: { url: url, comment_liked: comment_liked, like_id: comment_like_id, story_or_comment: comment, method: req_method } %>
        <div>
          <div>Replies to comment id: <%= comment.id %>, title: <%= comment.content %></div>
          <ul>
            <% comment.get_replies.each do |reply|  %>
              <% comment_liked = reply.liked?(reply.id, current_user.id) %>
              <% if comment_liked %>
                <% url = comment_like_url %>
                <% req_method = "delete" %>
                <% comment_like_id = reply.like_id(reply.id, current_user.id) %>
              <% else %>
                <% url = comment_comment_likes_url(reply.id) %>
                <% req_method = "post" %>
                <% comment_like_id = nil %>
              <% end %>
              <li>
                <div class=""><%= reply.content%></div>
                <div class="">by <a href="<%= user_url(reply.user.id) %>"><%= reply.user.username %></a></div>
                <%= render partial: "likes/comment_like_form", locals: { url: url, comment_liked: comment_liked, like_id: comment_like_id, story_or_comment: comment, method: req_method } %>
                <%= render partial: "comments/destroy", locals: { id: reply.id } %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </li>
  <% end %>
</ul>